<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Student Dashboard</title>

<style>
* { box-sizing: border-box; }
body { margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f7fa; }

/* HEADER */
.header {
    background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    color:white;
    padding:20px 40px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.logout-btn {
    background: rgba(255,255,255,0.2);
    color:white;
    border:1px solid white;
    padding:8px 16px;
    border-radius:6px;
    cursor:pointer;
}
.logout-btn:hover { background: rgba(255,255,255,0.3); }

/* CONTAINER */
.container {
    max-width:1400px;
    margin:0 auto;
    padding:40px 20px;
    display:grid;
    grid-template-columns:100px 1fr;
    gap:20px;
}

/* SIDEBAR */
.sidebar {
    background:white;
    border-radius:12px;
    padding:16px;
    position:sticky;
    top:100px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:20px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

.add-section-card {
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    width:70px;
    height:70px;
    border-radius:50%;
    cursor:pointer;
    display:flex;
    justify-content:center;
    align-items:center;
}
.add-section-card:hover { transform:scale(1.1); }
.add-section-card .plus-icon { font-size:40px; color:white; }

.analytics-card {
    width:70px;
    height:70px;
    border-radius:50%;
    background:#f0f3ff;
    cursor:pointer;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-size:22px;
    transition:0.3s;
}
.analytics-card span {
    font-size:10px;
    font-weight:600;
    margin-top:2px;
}
.analytics-card:hover {
    background:#e0e7ff;
    transform:scale(1.1);
}

/* TIMELINE */
.timeline-card {
    width:70px;
    height:70px;
    border-radius:50%;
    background:linear-gradient(135deg,#ffb86b 0%,#ff7eb6 100%);
    cursor:pointer;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-size:22px;
    transition:0.3s;
}
.timeline-card span {
    font-size:10px;
    font-weight:600;
    margin-top:2px;
}
.timeline-card:hover { transform:scale(1.1); }

/* MAIN CONTENT */
.info-box {
    background:white;
    padding:30px;
    border-radius:12px;
    margin-bottom:30px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
}

.sections-container {
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
    gap:25px;
}

.section-card {
    background:#b0c4de;
    padding:30px;
    border-radius:15px;
    min-height:180px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    text-align:center;
    cursor:pointer;
    box-shadow:0 2px 12px rgba(0,0,0,0.1);
    border: 2px solid transparent;
    transition: all 0.3s;
}
.section-card:hover {
    transform:translateY(-6px);
    box-shadow:0 10px 25px rgba(0,0,0,0.15);
    border-color:#667eea;
}
.section-card h3 {
    margin:0 0 12px 0;
    font-size:20px;
    font-weight:700;
}
.section-card p {
    margin:0 0 12px 0;
    font-size:14px;
    color:#333;
}

/* Buttons */
.section-actions { display:flex; gap:10px; justify-content:center; }
.section-btn { padding:8px 14px; border:none; border-radius:5px; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.2s; }
.share-btn { background:#27ae60; color:white; }
.share-btn:hover { background:#229954; }
.rename-btn { background:#667eea; color:white; }
.rename-btn:hover { background:#5568d3; }
.delete-btn { background:#e74c3c; color:white; }
.delete-btn:hover { background:#c0392b; }

.empty-state {
    text-align:center;
    padding:60px;
    color:#999;
}

/* MODAL */
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
.modal.show { display:flex; }
.modal-content { background:white; padding:30px; border-radius:12px; width:90%; max-width:400px; }
.modal-input { width:100%; padding:10px; margin-bottom:20px; }
.modal-buttons { display:flex; justify-content:flex-end; gap:10px; }
.modal-btn { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.3s; }
.save-btn { background:#27ae60; color:white; }
.save-btn:hover { background:#229954; }
.cancel-btn { background:#ddd; color:#333; }
.cancel-btn:hover { background:#ccc; }

/* small student tweaks */
.welcome-box { background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:20px; border-radius:12px; margin-bottom:20px; }

/* Group label shown beneath header */
.group-info { font-size:14px; color:#333; margin-bottom:6px; }
.header .group-info { color: rgba(255,255,255,0.95); margin-bottom:0; font-weight:600; font-size:14px; }

.dashboard-sections { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:20px; }
.dashboard-card { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,0.06); }
.progress-circle { font-size:42px; font-weight:700; color:#667eea; text-align:center; }
.progress-label { text-align:center; color:#666; }

</style>
</head>

<body>

<div class="header">
    <div style="display:flex;flex-direction:column;gap:6px;">
        <h1>üéì Student Dashboard</h1>
        <div id="groupInfo" class="group-info" aria-live="polite" style="font-weight:600;font-size:14px;opacity:0.95;"></div>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="container">

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="add-section-card" title="Overview" onclick="document.querySelector('.dashboard-sections').scrollIntoView({behavior:'smooth'})">
            <div class="plus-icon">üìä</div>
        </div>

        <div class="analytics-card" title="Paper Creator" onclick="(function(){ if(localStorage.getItem('currentSection')){}; window.location.href='research-paper-creator.html'; })()">
            üìù<span>Paper</span>
        </div>

        <div class="analytics-card timeline-card" onclick="openTimelineModal()" title="Timeline">
            üïí<span>Timeline</span>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="info-box welcome-box">
            <h2>Welcome to Student Dashboard</h2>
            <p>Track your progress, submit assignments, and communicate with your advisor.</p>
        </div>

        <!-- Due tomorrow banner (hidden when none) -->
        <div id="dueNotifications" class="info-box" style="display:none;margin-top:10px;"> </div>

        <!-- Student dashboard cards below -->
        <div class="dashboard-sections" style="margin-top:30px;">
            <div class="dashboard-card">
                <h3>üìà Progress Percentage</h3>
                <div class="progress-circle" id="overallProgress">0%</div>
                <p class="progress-label">Overall research completion</p>
            </div>

            <div class="dashboard-card">
                <h3>üìù Tasks</h3>
                <ul class="task-list" id="tasksList">
                    <!-- tasks due tomorrow will be populated here -->
                </ul>
                <div id="tasksEmpty" class="no-data" style="font-size:13px;color:#999;display:none;margin-top:8px;">No tasks due tomorrow.</div>
            </div>

            <div class="dashboard-card overview-card" id="overviewSummary">
                <h3>üîç Overview</h3>
                <div id="overviewStatus" style="margin-bottom:10px; color:#333;"></div>
                <div style="display:flex; gap:12px; margin-bottom:10px; align-items:flex-start;">
                    <div style="flex:1;">
                        <strong>Upcoming</strong>
                        <div id="upcomingList" style="font-size:13px; color:#666; margin-top:6px; min-height:34px;">‚Äî</div>
                    </div>
                    <div style="flex:1;">
                        <strong>Recently Edited</strong>
                        <div id="recentEdits" style="font-size:13px; color:#666; margin-top:6px; min-height:34px;">‚Äî</div>
                    </div>
                </div>
            </div>
        </div>


        <div id="coursesContainer" class="empty-state">
            <p>No courses assigned yet. Contact your advisor for enrollment.</p>
        </div>

    </div>

    <!-- TIMELINE MODAL (read-only for students) -->
    <div id="timelineModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <h2>Research Timeline</h2>
            <div id="timelineList" style="max-height:240px;overflow:auto;margin-bottom:10px;">
                <!-- entries will appear here -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn" onclick="closeTimelineModal()">Close</button>
            </div>
        </div>
    </div>

</div>

<script>
/* Progress animation and dashboard behavior */
document.addEventListener('DOMContentLoaded', () => {
    // Progress animation
    let target = 72;
    let current = 0;
    const el = document.getElementById('overallProgress');
    const timer = setInterval(() => {
        if (current >= target) clearInterval(timer);
        else el.textContent = ++current + "%";
    }, 15);

    // Initialize variables
    let sectionName = null;
    let groupsFromUrl = [];
    let currentGroup = null;

    // Parse URL params
    try {
        const params = new URLSearchParams(location.search);
        if (params.has('section')) {
            sectionName = decodeURIComponent(params.get('section'));
        }
        if (params.has('groups')) {
            try {
                groupsFromUrl = JSON.parse(decodeURIComponent(params.get('groups')));
            } catch(e) {
                console.warn('Failed to parse groups param', e);
            }
        }
    } catch(e) { console.warn('Failed to read URL params', e); }

    // Fallback to localStorage
    const storedSection = JSON.parse(localStorage.getItem('currentSection') || 'null');
    if (!sectionName && storedSection) sectionName = storedSection.name || storedSection;

    // Use groups from localStorage if not provided in URL
    const allSectionGroups = JSON.parse(localStorage.getItem('allSectionGroups') || '{}');
    const groupsFromStorage = sectionName ? (allSectionGroups[sectionName] || []) : [];
    const groups = groupsFromUrl.length ? groupsFromUrl : groupsFromStorage;

    // Determine current group
    const storedCurrentGroup = JSON.parse(localStorage.getItem('currentGroup') || 'null');
    if (storedCurrentGroup) currentGroup = storedCurrentGroup;
    else if (groups.length) currentGroup = groups[0];

    // Update UI
    // Keep current section in storage for contextual navigation, and show chosen group below the header
    if (sectionName) {
        localStorage.setItem('currentSection', JSON.stringify({ name: sectionName }));
    }

    const groupInfoEl = document.getElementById('groupInfo');
    function getGroupLabel(g){
        if(!g) return null;
        if(typeof g === 'string') return g;
        return g.groupName || g.name || g.group || null;
    }

    function updateHeaderLabel(){
        const storedGroup = JSON.parse(localStorage.getItem('currentGroup') || 'null');
        const storedSection = JSON.parse(localStorage.getItem('currentSection') || 'null');
        const curGroup = currentGroup || storedGroup;
        const curSection = sectionName || (storedSection && (storedSection.name || storedSection));
        const groupLabel = getGroupLabel(curGroup);

        if(!groupInfoEl) return;
        if(curSection && groupLabel){
            groupInfoEl.textContent = 'Section: ' + curSection + ' ‚Ä¢ ' + groupLabel;
            groupInfoEl.style.display = 'block';
        } else if(curSection){
            groupInfoEl.textContent = 'Section: ' + curSection;
            groupInfoEl.style.display = 'block';
        } else if(groupLabel){
            groupInfoEl.textContent = groupLabel;
            groupInfoEl.style.display = 'block';
        } else {
            groupInfoEl.style.display = 'none';
        }
    }

    // Initial set and keep it in sync when storage changes, page regains focus, or becomes visible
    updateHeaderLabel();
    renderTasksFromTimeline();
    window.addEventListener('storage', (e) => {
        if(e.key === 'currentGroup' || e.key === 'currentSection') updateHeaderLabel();
        if(e.key === 'timelineSections' || e.key === 'researchTimeline') { renderTasksFromTimeline(); renderOverviewSummary(); }
    });
    document.addEventListener('visibilitychange', () => { if(!document.hidden) { updateHeaderLabel(); renderTasksFromTimeline(); } });
    window.addEventListener('focus', () => { updateHeaderLabel(); renderTasksFromTimeline(); });

    // TIMELINE: read-only viewer for students (loads advisor timeline entries)
    let studentTimelineEntries = [];
    function loadStudentTimeline(){
        // Prefer the advisor 'researchTimeline' entry (title + date)
        studentTimelineEntries = JSON.parse(localStorage.getItem('researchTimeline') || '[]');
        // Fallback to timelineSections if present (name/deadline)
        if(!studentTimelineEntries || !studentTimelineEntries.length){
            const secs = JSON.parse(localStorage.getItem('timelineSections') || '[]');
            studentTimelineEntries = secs.map(s => ({ title: s.name, date: s.deadline }));
        }
    }

    function openTimelineModal(){
        loadStudentTimeline();
        renderStudentTimeline();
        const m = document.getElementById('timelineModal');
        if(m) { m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
    }
    function closeTimelineModal(){
        const m = document.getElementById('timelineModal');
        if(m) { m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
    }

    function renderStudentTimeline(){
        const list = document.getElementById('timelineList');
        list.innerHTML = '';
        if(!studentTimelineEntries || !studentTimelineEntries.length){
            list.innerHTML = '<div style="color:#777;padding:10px;">No timeline events yet.</div>';
            return;
        }
        studentTimelineEntries.forEach(t=>{
            const div = document.createElement('div');
            div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee;"><div><strong>${t.title}</strong><div style="color:#666;font-size:12px">${t.date || ''}</div></div></div>`;
            list.appendChild(div);
        });
    }

    // Keep timeline up to date when storage changes
    window.addEventListener('storage', (e)=>{ if(e.key === 'researchTimeline' || e.key === 'timelineSections') { if(document.getElementById('timelineModal') && document.getElementById('timelineModal').classList.contains('show')) { loadStudentTimeline(); renderStudentTimeline(); } }});

    // Expose timeline controls to the global scope so the sidebar's inline onclick can call them
    window.openTimelineModal = openTimelineModal;
    window.closeTimelineModal = closeTimelineModal;

    // Render Tasks based on timeline: show items due tomorrow (student-facing task reminders)
    function renderTasksFromTimeline(){
        const tasksEl = document.getElementById('tasksList');
        const emptyEl = document.getElementById('tasksEmpty');
        if(!tasksEl) return;

        // Prefer timelineSections with name/deadline, fallback to researchTimeline
        const timeline = JSON.parse(localStorage.getItem('timelineSections') || '[]');
        const source = (timeline && timeline.length) ? timeline : (JSON.parse(localStorage.getItem('researchTimeline') || '[]').map(t=>({ name: t.title, deadline: t.date })) || []);

        const today = new Date(); today.setHours(0,0,0,0);
        const items = source.map(t => ({ name: t.name, deadline: new Date((t.deadline||'') + 'T00:00:00') })).filter(i=>!isNaN(i.deadline)).map(i => ({ name: i.name, daysLeft: Math.floor((i.deadline - today)/(24*60*60*1000)), deadline: i.deadline }));

        const dueTomorrow = items.filter(it => it.daysLeft === 1);

        tasksEl.innerHTML = '';
        if(!dueTomorrow.length){
            if(emptyEl) emptyEl.style.display = 'block';
            return;
        }
        if(emptyEl) emptyEl.style.display = 'none';

        dueTomorrow.forEach(it=>{
            const li = document.createElement('li');
            li.innerHTML = `Submit <strong>${it.name}</strong> <span class="task-pending">Due tomorrow</span>`;
            tasksEl.appendChild(li);
        });
    }

    // Sidebar feature handlers
    (function(){
        const ov = document.querySelector('.feature-card.overview');
        const paper = document.querySelector('.feature-card.paper');
        if (ov) {
            ov.addEventListener('click', () => {
                const target = document.getElementById('overallProgress') || document.querySelector('.dashboard-sections');
                if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
            ov.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') ov.click(); });
        }
        if (paper) {
            paper.addEventListener('click', () => {
                // Pass current section context if available
                if (sectionName) localStorage.setItem('currentSection', JSON.stringify({ name: sectionName }));
                window.location.href = 'research-paper-creator.html';
            });
            paper.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') paper.click(); });
        }
    })();

    // Make logout reusable (also used by header button)
    function logout(){
        localStorage.removeItem('loggedInUser');
        localStorage.removeItem('userRole');
        localStorage.removeItem('currentGroup');
        localStorage.removeItem('currentSection');
        window.location.href = 'login.html';
    }

    const oldLogoutBtn = document.getElementById('logoutBtn');
    if(oldLogoutBtn){ oldLogoutBtn.addEventListener('click', logout); }


    // render initial overview summary
    document.addEventListener('DOMContentLoaded', renderOverviewSummary);

    // allow refresh of overview when page becomes visible (useful after editing on the editor page)
    document.addEventListener('visibilitychange', function(){ if (!document.hidden) renderOverviewSummary(); });
});

// Overview & recent edits
function getPaperKeyForDashboard(){
    try{
        const g = JSON.parse(localStorage.getItem('currentGroup') || 'null');
        if (g && (g.id || g.name)) return 'paper_' + (g.id || g.name);
        const u = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
        if (u && (u.id || u.name)) return 'paper_user_' + (u.id || u.name);
    }catch(e){}
    return 'paper_anonymous';
}

function renderOverviewSummary(){
    const key = getPaperKeyForDashboard();
    let payload = {};
    try { payload = JSON.parse(localStorage.getItem(key) || '{}'); } catch(e) { payload = {}; }

    const sections = payload.sections || {};
    const timestamps = payload.timestamps || {};
    const sectionNames = ['Title','Introduction','Methodology','Results','Discussion','Conclusion'];

    // Completion by filled sections
    const filled = sectionNames.filter(s => (sections[s] || '').replace(/<[^>]*>/g, '').trim().length > 0).length;
    const total = sectionNames.length;
    const completion = Math.round((filled/total) * 100);

    // status text
    let status = 'Not Started';
    if (filled === 0) status = 'Not Started';
    else if (filled === total) status = 'Completed';
    else status = 'In Progress';

    const statusEl = document.getElementById('overviewStatus');
    if (statusEl) statusEl.innerHTML = `<div><strong>Status:</strong> ${status} &nbsp; &nbsp; <strong>Sections done:</strong> ${filled}/${total} &nbsp; &nbsp; <strong>Completion:</strong> ${completion}%</div>`;

    // upcoming tasks from timelineSections + 'due tomorrow' notifications
    const upcomingEl = document.getElementById('upcomingList');
    const dueBannerEl = document.getElementById('dueNotifications');
    try{
        // prefer timelineSections which contains name/deadline
        const timeline = JSON.parse(localStorage.getItem('timelineSections') || '[]');
        const source = (timeline && timeline.length) ? timeline : (JSON.parse(localStorage.getItem('researchTimeline') || '[]').map(t=>({ name: t.title, deadline: t.date })) || []);
        if (!source || !source.length){ upcomingEl.innerHTML = '<div class="no-data">No deadlines set.</div>'; if(dueBannerEl) dueBannerEl.style.display='none'; }
        else{
            const today = new Date(); today.setHours(0,0,0,0);
            const soon = source.map(t => ({ name: t.name, deadline: new Date((t.deadline || '') + 'T00:00:00') })).filter(i=>!isNaN(i.deadline)).map(item => { return { name: item.name, daysLeft: Math.floor((item.deadline - today)/(24*60*60*1000)), deadline: item.deadline }; }).sort((a,b)=>a.daysLeft - b.daysLeft);

            const show = soon.slice(0,3).map(it => `<div style="margin-bottom:6px;">${it.name} ‚Äî ${it.daysLeft < 0 ? 'Overdue ' + Math.abs(it.daysLeft) + 'd' : it.daysLeft===0 ? 'Due Today' : 'In ' + it.daysLeft + 'd'}</div>`).join('');
            upcomingEl.innerHTML = show || '<div class="no-data">No upcoming tasks</div>';

            // Find events due tomorrow
            const dueTomorrow = soon.filter(it => it.daysLeft === 1);
            if(dueBannerEl){
                if(dueTomorrow.length){
                    dueBannerEl.style.display = 'block';
                    dueBannerEl.innerHTML = dueTomorrow.map(it=>`<div style="margin-bottom:6px;">Reminder: <strong>${it.name}</strong> is due <strong>tomorrow</strong> (${it.deadline.toLocaleDateString()})</div>`).join('');

                    // Send browser notification once per event per session
                    dueTomorrow.forEach(it=>{
                        const key = 'notified_' + encodeURIComponent(it.name + '_' + it.deadline.toISOString().slice(0,10));
                        if(!sessionStorage.getItem(key)){
                            // Request permission and show notification
                            if('Notification' in window){
                                if(Notification.permission === 'granted'){
                                    new Notification('Reminder: ' + it.name + ' is due tomorrow', { body: it.name + ' ‚Äî due ' + it.deadline.toLocaleDateString() });
                                    sessionStorage.setItem(key,'1');
                                } else if(Notification.permission !== 'denied'){
                                    Notification.requestPermission().then(p => { if(p==='granted'){ new Notification('Reminder: ' + it.name + ' is due tomorrow', { body: it.name + ' ‚Äî due ' + it.deadline.toLocaleDateString() }); sessionStorage.setItem(key,'1'); } });
                                }
                            }
                        }
                    });
                } else {
                    dueBannerEl.style.display = 'none';
                }
            }
        }
    }catch(e){ upcomingEl.innerHTML = '<div class="no-data">No timeline data</div>'; if(dueBannerEl) dueBannerEl.style.display='none'; }

    // recent edits
    const recentEl = document.getElementById('recentEdits');
    const items = Object.keys(timestamps).filter(k=>timestamps[k]).map(k=>({ section: k, time: timestamps[k] })).sort((a,b)=> new Date(b.time) - new Date(a.time));
    if (!items.length){ recentEl.innerHTML = '<div class="no-data">No recent edits</div>'; }
    else{
        const html = items.slice(0,4).map(it => {
            const d = new Date(it.time);
            return `<div class="recent-item" data-section="${encodeURIComponent(it.section)}">${it.section} ‚Äî <small>${d.toLocaleString()}</small></div>`;
        }).join('');
        recentEl.innerHTML = html;

        // click to open in paper creator (with section preselect)
        recentEl.querySelectorAll('.recent-item').forEach(el => {
            el.addEventListener('click', () => {
                const section = decodeURIComponent(el.getAttribute('data-section'));
                // Save context and open creator with ?section=
                const url = 'research-paper-creator.html?section=' + encodeURIComponent(section);
                window.location.href = url;
            });
        });
    }
}

</script>

</body>
</html>
